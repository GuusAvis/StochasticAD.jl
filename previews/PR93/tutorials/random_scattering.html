<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Random scattering (deflection) of a single particle · StochasticAD.jl</title><meta name="title" content="Random scattering (deflection) of a single particle · StochasticAD.jl"/><meta property="og:title" content="Random scattering (deflection) of a single particle · StochasticAD.jl"/><meta property="twitter:title" content="Random scattering (deflection) of a single particle · StochasticAD.jl"/><meta name="description" content="Documentation for StochasticAD.jl."/><meta property="og:description" content="Documentation for StochasticAD.jl."/><meta property="twitter:description" content="Documentation for StochasticAD.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/indigo.css" rel="stylesheet" type="text/css"/><link href="../assets/extra_styles.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">StochasticAD.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Overview</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="random_walk.html">Random walk</a></li><li><a class="tocitem" href="game_of_life.html">Stochastic Game of Life</a></li><li><a class="tocitem" href="particle_filter.html">Differentiable particle filter</a></li><li><a class="tocitem" href="optimizations.html">Stochastic optimizations with discrete randomness</a></li><li class="is-active"><a class="tocitem" href="random_scattering.html">Random scattering (deflection) of a single particle</a><ul class="internal"><li><a class="tocitem" href="#Intro-and-Setup"><span>Intro and Setup</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../public_api.html">Public API</a></li><li><a class="tocitem" href="../devdocs.html">Developer documentation</a></li><li><a class="tocitem" href="../limitations.html">Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href="random_scattering.html">Random scattering (deflection) of a single particle</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="random_scattering.html">Random scattering (deflection) of a single particle</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gaurav-arya/StochasticAD.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gaurav-arya/StochasticAD.jl/blob/main/docs/src/tutorials/random_scattering.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Random-scattering-(deflection)-of-a-single-particle"><a class="docs-heading-anchor" href="#Random-scattering-(deflection)-of-a-single-particle">Random scattering (deflection) of a single particle</a><a id="Random-scattering-(deflection)-of-a-single-particle-1"></a><a class="docs-heading-anchor-permalink" href="#Random-scattering-(deflection)-of-a-single-particle" title="Permalink"></a></h1><h2 id="Intro-and-Setup"><a class="docs-heading-anchor" href="#Intro-and-Setup">Intro and Setup</a><a id="Intro-and-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Intro-and-Setup" title="Permalink"></a></h2><p>In this tutorial we implement and differentiate through a single particle scattering process.</p><p>In short, when a particle travels through some material with finite depth, at each step, the particle has a chance (!) to interact, when it does, it loses energy and randomly change direction <sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup>.</p><pre><code class="language-julia hljs">using StochasticAD, Statistics, Distributions</code></pre><p>First of all, the interaction probability is controlled by a parameter <code>par</code>, think of this as material property (~density), which we might be intereted in differentiate against to optimize material.</p><pre><code class="language-julia hljs">&quot;&quot;&quot;
Probability of interaction is a function of parameter we&#39;re intereted in diff. against
&quot;&quot;&quot;
function interact_prob(x,par)
    return 1/(1+exp(-(x-par)/0.2))*0.5
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.interact_prob</code></pre><p>Then, we implement the &quot;one step&quot; in propagating particle, note instead of <code>if scattered ...</code>, we need to do it branchlessly, we also decide when interaction happens, we lose 10% of energy.</p><pre><code class="language-julia hljs">&quot;&quot;&quot;
A single step of propagation, next1 and next2 are branchless &quot;next state of particle&quot;
&quot;&quot;&quot;
function propagate_scatter(E,phi,x,y,par)
    x = x + cos(phi)
    y = y + sin(phi)

    prob = interact_prob(x,par)
    scattered = rand(Bernoulli(prob))

    next1 = (E,x,y,phi)

    E0 = E*0.9 # lose 10% of energy
    phi0 = phi + 0.01*randn() # change direction
    next2 = (E0,x,y,phi0)

    # TODO: use better scattering coupling
    idx = 1+scattered
    return Tuple([next1[i], next2[i]][idx] for i in 1:4) # TODO: make this more ergonomic
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.propagate_scatter</code></pre><p>Also, we need a stopping criteria, here we assume the material extends to <code>x=10</code> in space, thus when particle leaves the volumn, we stop keeping it:</p><pre><code class="language-julia hljs">decidetokeep(x, a, b) = x &lt; 10 ? a : b
decidetokeep(x::StochasticAD.StochasticTriple, a, b) = StochasticAD.propagate(decidetokeep, x, a, b)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">decidetokeep (generic function with 2 methods)</code></pre><p>Finally, the main process:</p><pre><code class="language-julia hljs">function generate_scatter(;E = 50.0, phi = 0.0, y = 0.0, par = 2.5)
    x = zero(par)
    xs = typeof(x)[]
    while true # TODO: improve while loop coupling (software + coupling strength)
	    next = propagate_scatter(E,phi,x,y,par)
        # &quot;c&quot; for candidate
		Ec, xc, yc, phic = next
        E, x, y, phi = decidetokeep(x, (Ec, xc, yc, phic), (E, x, y, phi))
        # TODO: make this automatic
        if StochasticAD.value(x) &gt;= 10
            if !(x isa StochasticAD.StochasticTriple)
                break
            else
                xval = StochasticAD.value(x)
                if StochasticAD.alltrue(Δ -&gt; (Δ + xval) &gt;= 10, x.Δs)
                   break
                end
            end
        end
        push!(xs, x)
	end
    return E
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">generate_scatter (generic function with 1 method)</code></pre><p>The logic behind <code>make this automatic</code> part is the following: after some amount of iteration, the primal may have terminated but with alternative still going (or vise versa), so we need to check that not only the primal has terminated, but all of the perterbations have also terminated.</p><pre><code class="language-julia hljs">obj(par) = generate_scatter(; par)

@show obj(2.5)

@show derivative_estimate(obj, 2.5)
samples_st = [derivative_estimate(obj, 2.5) for i in 1:10000]
@show mean(samples_st)
@show std(samples_st) / sqrt(length(samples_st))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.029371776986972173</code></pre><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>Technically, energy loss of charged particle (dE/dx) happens continuously in dense material, so this &quot;chance to lose energy&quot; might be more like mean free path in gas. But we just want something simple to picture and implement.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="optimizations.html">« Stochastic optimizations with discrete randomness</a><a class="docs-footer-nextpage" href="../public_api.html">Public API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Wednesday 8 November 2023 10:27">Wednesday 8 November 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
