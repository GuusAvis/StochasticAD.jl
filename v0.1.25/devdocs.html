<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Developer documentation · StochasticAD.jl</title><meta name="title" content="Developer documentation · StochasticAD.jl"/><meta property="og:title" content="Developer documentation · StochasticAD.jl"/><meta property="twitter:title" content="Developer documentation · StochasticAD.jl"/><meta name="description" content="Documentation for StochasticAD.jl."/><meta property="og:description" content="Documentation for StochasticAD.jl."/><meta property="twitter:description" content="Documentation for StochasticAD.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script><link href="assets/indigo.css" rel="stylesheet" type="text/css"/><link href="assets/extra_styles.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">StochasticAD.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="index.html">Overview</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="tutorials/random_walk.html">Random walk</a></li><li><a class="tocitem" href="tutorials/game_of_life.html">Stochastic Game of Life</a></li><li><a class="tocitem" href="tutorials/particle_filter.html">Differentiable particle filter</a></li><li><a class="tocitem" href="tutorials/optimizations.html">Stochastic optimizations with discrete randomness</a></li></ul></li><li><a class="tocitem" href="public_api.html">Public API</a></li><li class="is-active"><a class="tocitem" href="devdocs.html">Developer documentation</a><ul class="internal"><li><a class="tocitem" href="#Writing-a-custom-rule-for-stochastic-triples"><span>Writing a custom rule for stochastic triples</span></a></li><li><a class="tocitem" href="#Distribution-specific-customization-of-differentiation-algorithm"><span>Distribution-specific customization of differentiation algorithm</span></a></li></ul></li><li><a class="tocitem" href="limitations.html">Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="devdocs.html">Developer documentation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="devdocs.html">Developer documentation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gaurav-arya/StochasticAD.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gaurav-arya/StochasticAD.jl/blob/main/docs/src/devdocs.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Developer-documentation-(WIP)"><a class="docs-heading-anchor" href="#Developer-documentation-(WIP)">Developer documentation (WIP)</a><a id="Developer-documentation-(WIP)-1"></a><a class="docs-heading-anchor-permalink" href="#Developer-documentation-(WIP)" title="Permalink"></a></h1><h2 id="Writing-a-custom-rule-for-stochastic-triples"><a class="docs-heading-anchor" href="#Writing-a-custom-rule-for-stochastic-triples">Writing a custom rule for stochastic triples</a><a id="Writing-a-custom-rule-for-stochastic-triples-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-a-custom-rule-for-stochastic-triples" title="Permalink"></a></h2><h3 id="via-StochasticAD.propagate"><a class="docs-heading-anchor" href="#via-StochasticAD.propagate">via <code>StochasticAD.propagate</code></a><a id="via-StochasticAD.propagate-1"></a><a class="docs-heading-anchor-permalink" href="#via-StochasticAD.propagate" title="Permalink"></a></h3><p>To handle a deterministic discrete construct that <code>StochasticAD</code> does not automatically handle (e.g. branching via <code>if</code>, boolean comparisons), it is often sufficient to simply add a dispatch rule that calls out to <code>StochasticAD.propagate</code>.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StochasticAD.propagate" href="#StochasticAD.propagate"><code>StochasticAD.propagate</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">propagate(f, args...; keep_deltas = Val(false))</code></pre><p>Propagates <code>args</code> through a function <code>f</code>, handling stochastic triples by independently running <code>f</code> on the primal and the alternatives, rather than by inspecting the internals of <code>f</code> (which may possibly be unsupported by <code>StochasticAD</code>). Currently handles deterministic functions <code>f</code> with any input and output that is <code>fmap</code>-able by <code>Functors.jl</code>. If <code>f</code> has a continuously differentiable component, provide <code>keep_deltas = Val(true)</code>.</p><p>This functionality is orthogonal to dispatch: the idea is for this function to be the &quot;backend&quot; for operator  overloading rules based on dispatch. For example:</p><pre><code class="language-julia hljs">using StochasticAD, Distributions
import Random # hide
Random.seed!(4321) # hide

function mybranch(x)
    str = repr(x) # string-valued intermediate!
    if length(str) &lt; 2
        return 3
    else
        return 7
    end
end

function f(x)
    return mybranch(9 + rand(Bernoulli(x)))
end

# stochastic_triple(f, 0.5) # this would fail

# Add a dispatch rule for mybranch using StochasticAD.propagate
mybranch(x::StochasticAD.StochasticTriple) = StochasticAD.propagate(mybranch, x)

stochastic_triple(f, 0.5) # now works

# output

StochasticTriple of Int64:
3 + 0ε + (4 with probability 2.0ε)</code></pre><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>This function is experimental and subject to change.</p></div></div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/gaurav-arya/StochasticAD.jl/blob/f4c51d2d7260ecaa9a6f59580b69cf7a8a64e3fb/src/propagate.jl#L44-L88">source</a></section></article><h3 id="via-a-custom-dispatch"><a class="docs-heading-anchor" href="#via-a-custom-dispatch">via a custom dispatch</a><a id="via-a-custom-dispatch-1"></a><a class="docs-heading-anchor-permalink" href="#via-a-custom-dispatch" title="Permalink"></a></h3><p>If a function does not meet the conditions of <code>StochasticAD.propagate</code> and is not already supported, a custom dispatch may be necessary. For example, consider the following function which manually implements a geometric random variable:</p><pre><code class="language-julia hljs">import Random
using Distributions
# make rng input explicit
function mygeometric(rng, p)
    x = 0
    while !(rand(rng, Bernoulli(p)))
        x += 1
    end
    return x
end
mygeometric(p) = mygeometric(Random.default_rng(), p)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">mygeometric (generic function with 2 methods)</code></pre><p>This is equivalent to <code>rand(Geometric(p))</code> which is already supported, but for pedagogical purposes we will implement our own rule from scratch. Using the stochastic derivative formulas from <a href="https://doi.org/10.48550/arXiv.2210.08572">Automatic Differentiation of Programs with Discrete Randomness</a>, the right stochastic derivative of this program is given by</p><p class="math-container">\[Y_R = X - 1, w_R = \frac{x}{p(1-p)},\]</p><p>and the left stochastic derivative of this program is given by</p><p class="math-container">\[Y_L = X + 1, w_L = -\frac{x+1}{p}.\]</p><p>Using these expressions, we can now write the dispatch rule for stochastic triples:</p><pre><code class="language-julia hljs">using StochasticAD
import StochasticAD: StochasticTriple, similar_new, similar_empty, combine
function mygeometric(rng, p_st::StochasticTriple{T}) where {T}
    p = p_st.value
    rng_copy = copy(rng) # save a copy for coupling later
    x = mygeometric(rng, p)

    # Form the new discrete perturbations (combinations of weight w and perturbation Y - X)
    Δs1 = if p_st.δ &gt; 0
        # right stochastic derivative
        w = p_st.δ * x / (p * (1 - p))
        x &gt; 0 ? similar_new(p_st.Δs, -1, w) : similar_empty(p_st.Δs, Int)
    elseif p_st.δ &lt; 0
        # left stochastic derivative
        w = -p_st.δ * (x + 1) / p # positive since the negativity of p_st.δ cancels out the negativity of w_L
        similar_new(p_st.Δs, 1, w)
    else
        similar_empty(p_st.Δs, Int)
    end

    # Propagate any existing perturbations to p through the function
    function map_func(Δ)
        # Couple the samples by using the same RNG. (A simpler strategy would have been independent sampling, i.e. mygeometric(p + Δ) - x)
        mygeometric(copy(rng_copy), p + Δ) - x
    end
    Δs2 = map(map_func, p_st.Δs)

    # Return the output stochastic triple
    StochasticTriple{T}(x, zero(x), combine((Δs2, Δs1)))
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">mygeometric (generic function with 3 methods)</code></pre><p>In the above, we used some of the interface functions supported by a collection of perturbations <code>Δs::StochasticAD.AbstractFIs</code>. These were <code>similar_empty(Δs, V)</code>, which created an empty perturbation of type <code>V</code>, <code>similar_new(Δs, Δ, w)</code>, which created a new perturbation of size <code>Δ</code> and weight <code>w</code>, <code>map(map_func, Δs)</code>, which propagates a collection of perturbations through a mapping function, and <code>combine((Δs2, Δs1)))</code> which combines multiple collections of perturbations together.</p><p>We can test out our rule:</p><pre><code class="language-julia hljs">@show stochastic_triple(mygeometric, 0.1)

# try feeding an input that already has a pertrubation
f(x) = mygeometric(2 * x + 0.1 * rand(Bernoulli(x)))^2
@show stochastic_triple(f, 0.1)

# verify against black-box finite differences
N = 1000000
samples_stochad = [derivative_estimate(f, 0.1) for i in 1:N]
samples_fd = [(f(0.105) - f(0.095)) / 0.01 for i in 1:N]

println(&quot;Stochastic AD: $(mean(samples_stochad)) ± $(std(samples_stochad) / sqrt(N))&quot;)
println(&quot;Finite differences: $(mean(samples_fd)) ± $(std(samples_fd) / sqrt(N))&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">stochastic_triple(mygeometric, 0.1) = 12 + 0ε + (-1 with probability 133.33333333333331ε)
stochastic_triple(f, 0.1) = 36 + 0ε + (-11 with probability 74.99999999999999ε)
Stochastic AD: -810.1971013095236 ± 2.2547264032095446
Finite differences: -814.9264 ± 11.828743174223884</code></pre><h2 id="Distribution-specific-customization-of-differentiation-algorithm"><a class="docs-heading-anchor" href="#Distribution-specific-customization-of-differentiation-algorithm">Distribution-specific customization of differentiation algorithm</a><a id="Distribution-specific-customization-of-differentiation-algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Distribution-specific-customization-of-differentiation-algorithm" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StochasticAD.randst" href="#StochasticAD.randst"><code>StochasticAD.randst</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">randst(rng, d::Distributions.Sampleable; kwargs...)</code></pre><p>When no keyword arguments are provided, <code>randst</code> behaves identically to <code>rand(rng, d)</code> in both ordinary computation and for stochastic triple dispatches. However, <code>randst</code> also allows the user to provide various keyword arguments for customizing the differentiation logic. The set of allowed keyword arguments depends on the type of <code>d</code>: a couple common ones are <code>derivative_coupling</code> and <code>propagation_coupling</code>.</p><p>For developers: if you wish to accept custom keyword arguments in a stochastic triple dispatch, you should overload <code>randst</code>, and redirect <code>rand</code> to your <code>randst</code> method. If you do not, it suffices to just overload <code>rand</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/gaurav-arya/StochasticAD.jl/blob/f4c51d2d7260ecaa9a6f59580b69cf7a8a64e3fb/src/discrete_randomness.jl#L291-L301">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StochasticAD.InversionMethodDerivativeCoupling" href="#StochasticAD.InversionMethodDerivativeCoupling"><code>StochasticAD.InversionMethodDerivativeCoupling</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">InversionMethodDerivativeCoupling(; mode::Val = Val(:positive_weight), handle_zeroprob::Val = Val(true))</code></pre><p>Specifies an inversion method coupling for generating perturbations from a univariate distribution. Valid choices of <code>mode</code> are <code>Val(:positive_weight)</code>, <code>Val(:always_right)</code>, and <code>Val(:always_left)</code>.</p><p><strong>Example</strong></p><pre><code class="language-julia-repl hljs">julia&gt; using StochasticAD, Distributions, Random; Random.seed!(4321);

julia&gt; function X(p)
           return randst(Bernoulli(1 - p); derivative_coupling = InversionMethodDerivativeCoupling(; mode = Val(:always_right)))
       end
X (generic function with 1 method)

julia&gt; stochastic_triple(X, 0.5)
StochasticTriple of Int64:
0 + 0ε + (1 with probability -2.0ε)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/gaurav-arya/StochasticAD.jl/blob/f4c51d2d7260ecaa9a6f59580b69cf7a8a64e3fb/src/discrete_randomness.jl#L39-L58">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="public_api.html">« Public API</a><a class="docs-footer-nextpage" href="limitations.html">Limitations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.0 on <span class="colophon-date" title="Monday 15 April 2024 01:55">Monday 15 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
